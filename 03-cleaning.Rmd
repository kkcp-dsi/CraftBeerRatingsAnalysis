---
editor_options: 
  markdown: 
    wrap: 72
---

# Data transformation

we used following python code to merge all the beer data and brewery
data.

## Merge Beer ratings data

``` {.python}
path = r'brewery_beers'
extension = '.csv'
csv_list = []
       
for root, dirs, files in os.walk(path):
    for filename in files:
        if os.path.splitext(filename)[-1] == extension:
            csv_list.append(os.path.join(root, filename))

frames = []
for file in csv_list:
    state_and_brewery = file.split('/')
    df = pd.read_csv(file, index_col=False)
    df.insert(1, 'brewery', state_and_brewery[2].split('.')[0])
    df.insert(2, 'state', state_and_brewery[2])
    df['state'] = state_and_brewery[1]
    df['brewery'] = state_and_brewery[2].split('.')[0]
    df.drop(df.columns[df.columns.str.contains('unnamed',case = False)],axis = 1, inplace = True)
    frames.append(df)

# exports to csv file
pd.concat(frames).to_csv('all_beers.csv')
```

We Added State and Brewery name to beer dataset in order to make it easy
for us to join brewery data to beer data.

## Merge Brewery Info data

``` {.python}
breweries_list = []
       
for root, dirs, files in os.walk(path):
    for filename in files:
        if os.path.splitext(filename)[-1] == extension:
            breweries_list.append(os.path.join(root, filename))

brewery_frames = []
for file in breweries_list:
    df = pd.read_csv(file, index_col=False)
    df.drop(df.columns[df.columns.str.contains('unnamed',case = False)],axis = 1, inplace = True)
    brewery_frames.append(df)

#exports to csv file    
pd.concat(brewery_frames).to_csv('all_breweries.csv')
```

# Data Cleaning

```{r}
library(tidyverse)
folder_path <- paste(getwd(), 'data', sep='/')
all_breweries <- read_csv(paste(folder_path, 'all_breweries.csv', sep='/'))
all_beers <- read_csv(paste(folder_path, 'all_beers.csv', sep='/'))
```

### Beer Ratings Data:

**Before Cleaning**

```{r}
rmarkdown::paged_table(sample_n(all_beers, 10))
```

Cleaned up the beer_abv column by removing the characters `% ABV` and
beer_ibu column by removing the characters `IBU` and converted those
columns to a double datatype.

Cleaned up date values to same format and added a new column named year.

Generalized known duplicated beer styles.

Cleaned up state name in cleaned_all_beers to remove `_` 's

```{r}
clean_up_beer_style <- function(beer_style_name) {
  if (beer_style_name == "IPA - Imperial / Double New England / Hazy") {
    return ("Double New England IPA")
  } else if (beer_style_name == "Red Ale - American Amber / Red") {
    return ("Red American Amber")
  } else if (beer_style_name %in% c("IPA - New England / Hazy", "IPA - New England")) {
    return ("New England IPA")
  } else if (beer_style_name == "IPA - Imperial / Double") {
    return ("Double IPA")
  } else if (beer_style_name == "Farmhouse Ale - Saison") {
    return ("Farmhouse Ale")
  } else if (beer_style_name == "Stout - Imperial / Double") {
    return ("Imperial Stout")
  } else if (beer_style_name %in% c("Sour - Fruited Gose",
                                    "Sour - Fruited Berliner Weisse")) {
    return ("Sour - Fruited")
  }
  
  return (beer_style_name)
}

cleaned_all_beers <- all_beers %>%
  mutate(beer_abv = as.double(str_trim(gsub(
    "%\\s+ABV", "", beer_abv
  )))) %>%
  mutate(beer_ibu = as.double(str_trim(gsub(
    "\\s+IBU", "", beer_ibu
  )))) %>%
  mutate(beer_added = as.Date(beer_added, format = "%m/%d/%y")) %>%
  mutate(year = format(beer_added, format = "%Y")) %>%
  mutate(beer_style = sapply(beer_style, clean_up_beer_style))

cleaned_all_beers$state <- gsub('_', ' ', cleaned_all_beers$state)
```

**After Cleaning**

```{r}
rmarkdown::paged_table(sample_n(cleaned_all_beers, 10))
```

### Brewery Info Data:

```{r}
rmarkdown::paged_table(sample_n(all_breweries, 10))
```

Removed un-necessary columns in all_breweries data frame and renamed
`name` to `brewery_name` column.

Cleaned breweries with less than 10 beers total and the breweries which
are closed, proprietor, bar as there are mostly useless for our
question.

```{r}
cleaned_all_breweries <-
  all_breweries %>% select(
    brewery_id,
    name,
    brewery_type,
    city,
    state,
    longitude,
    latitude,
    average_rating,
    num_of_ratings,
    num_of_beers,
    total_check_ins,
    unique_user_check_ins,
    brewery
  ) %>% rename(brewery_name = name) %>%
  filter(num_of_beers >= 10) %>% 
  filter(!brewery_type %in% c("proprietor", "bar", "nano", "closed"))
```

**After Cleaning**

```{r}
rmarkdown::paged_table(sample_n(cleaned_all_breweries, 10))
```
