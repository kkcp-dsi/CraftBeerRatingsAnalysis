---
editor_options: 
  markdown: 
    wrap: 72
---

# Data transformation

To merge all the beer ratings data downloaded by the web scrapper into a
single CSV file and brewery ratings data downloaded by the web scrapper
into a single CSV, we used a python script
[CraftBeerRatingsAnalysis/brewer_beer_parser/data_merger.py](https://github.com/kkcp-dsi/CraftBeerRatingsAnalysis/blob/main/brewery_beer_parser/data_merger.py)
available in the repository.

To run the data merger and save the merged csv files into data folder
follow below steps.

``` {.bash}
$ cd CraftBeerRatingsAnalysis/brewery_beer_parser

$ python3 data_merger.py
```

\*\* We added State and Brewery name to the beer dataset in order to
make it easy for us to join brewery data to beer data in case if we
needed that in our further analysis.

Merged data will be exported to `data` directory in the project.

**Beer data:** `CraftBeerRatingsAnalysis/data/all_beers.csv`

**Brewery Data:** `CraftBeerRatingsAnalysis/data/all_breweries.csv`

```{r}
library(tidyverse)
folder_path <- paste(getwd(), 'data', sep='/')
all_breweries <- read_csv(paste(folder_path, 'all_breweries.csv', sep='/'))
all_beers <- read_csv(paste(folder_path, 'all_beers.csv', sep='/'))
```

## Beer Ratings Data:

**Before Cleaning**

```{r}
rmarkdown::paged_table(sample_n(all_beers, 10))
```

We removed `% ABV` characters from the beer_abv column and `IBU`
characters from the beer_ibu column, then we converted these two columns
as numeric datatype. Next, we converted the beer_added column to date
datatype and also added a year column that will be required by the
downstream analysis. In addition, we standardized the beer style names
because the same style could be referred to differently in the data e.g.
IPA - New England / Hazy and IPA - New England both refer to the New
England IPA. Finally, we cleaned up state name in cleaned_all_beers to
remove `_` 's. After cleaning, we have 124,916 beers in total.

```{r}
clean_up_beer_style <- function(beer_style_name) {
  if (beer_style_name == "IPA - Imperial / Double New England / Hazy") {
    return ("Double New England IPA")
  } else if (beer_style_name == "Red Ale - American Amber / Red") {
    return ("Red American Amber")
  } else if (beer_style_name %in% c("IPA - New England / Hazy", "IPA - New England")) {
    return ("New England IPA")
  } else if (beer_style_name == "IPA - Imperial / Double") {
    return ("Double IPA")
  } else if (beer_style_name == "Farmhouse Ale - Saison") {
    return ("Farmhouse Ale")
  } else if (beer_style_name == "Stout - Imperial / Double") {
    return ("Imperial Stout")
  } else if (beer_style_name %in% c("Sour - Fruited Gose",
                                    "Sour - Fruited Berliner Weisse")) {
    return ("Sour - Fruited")
  }
  
  return (beer_style_name)
}

cleaned_all_beers <- all_beers %>%
  mutate(beer_abv = as.double(str_trim(gsub(
    "%\\s+ABV", "", beer_abv
  )))) %>%
  mutate(beer_ibu = as.double(str_trim(gsub(
    "\\s+IBU", "", beer_ibu
  )))) %>%
  mutate(beer_added = as.Date(beer_added, format = "%m/%d/%y")) %>%
  mutate(year = format(beer_added, format = "%Y")) %>%
  mutate(beer_style = sapply(beer_style, clean_up_beer_style))

cleaned_all_beers$state <- gsub('_', ' ', cleaned_all_beers$state)
```

**After Cleaning**

```{r}
rmarkdown::paged_table(sample_n(cleaned_all_beers, 10))
```

## Brewery Ratings Data:

```{r}
rmarkdown::paged_table(sample_n(all_breweries, 10))
```

We removed un-necessary columns in all_breweries dataset and renamed the
`name` column to `brewery_name`. Furthermore, we removed breweries
flagged as closed, proprietor, bar, and also breweries with less than 10
beers. After cleaning there are 5015 breweries in total.

```{r}
cleaned_all_breweries <-
  all_breweries %>% select(
    name,
    brewery_type,
    city,
    state,
    longitude,
    latitude,
    brewery_id,
    average_rating,
    num_of_ratings,
    num_of_beers,
    total_check_ins,
    unique_user_check_ins,
    brewery
  ) %>% rename(brewery_name = name) %>%
  filter(num_of_beers >= 10) %>% 
  filter(!brewery_type %in% c("proprietor", "bar", "nano", "closed"))
```

**After Cleaning**

```{r}
rmarkdown::paged_table(sample_n(cleaned_all_breweries, 10))
```
