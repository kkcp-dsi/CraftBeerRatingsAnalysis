<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Vertical Bar Chart</title>
    <script src="https://d3js.org/d3.v7.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
  </head>
  
  <body>
    <div class="container-fluid">
      <div class="row">
        <div class="col-4">
          <select id="states" style="width:100%"></select>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" value="" id="select_all_states">
            <label class="form-check-label" for="flexCheckDefault">
              Select all states
            </label>
          </div>
        </div>
      </div>
      <div class="row">
        <div class="col-6">
          <div id="state_hist"></div>
        </div>
        <div class="col-6">
          <div id="state_hist_popular"></div>
        </div>
      </div>
    </div>
  </body>
  <script>
    // This is what I need to compute kernel density estimation
    function kde(kernel, thresholds, data) {
      return thresholds.map(t => [t, d3.mean(data, d => kernel(t - d))]);
    }
    
    function epanechnikov(bandwidth) {
      return x => Math.abs(x /= bandwidth) <= 1 ? 0.75 * (1 - x * x) / bandwidth : 0;
    }
    
    
    function create_svg(d3_html_element, height, width, xAxis, yAxis, xAxisName){
      // append the svg object to the body of the page
      var _svg = d3_html_element.append("svg")
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom)
      .append("g")
        .attr("transform", "translate(" + margin.left + "," + margin.top + ")");
        
      _svg.append("g")
      .attr("class", "density")
    
      _svg.append("g")
        .attr("class", "xAxis")
        .attr("transform", "translate(0," + height + ")")
        .call(xAxis);
                  
      _svg.append("g")
        .attr("class", "yAxis")
        .call(yAxis);
        
      // Add X axis label:
      _svg.append("text")
          .attr("text-anchor", "end")
          .attr("x", width)
          .attr("y", height + 40)
          .text(xAxisName);
      return _svg;
    }
    
    function compute_density(states, state_data, ticks){
      var allDensity = [];
      for (i in states){
        var state = states[i]
        var density = kde(epanechnikov(0.3), ticks, state_data[state]);
        allDensity.push({
          key: state,
          median: d3.median(state_data[state]),
          density: density
        });
        
        allDensity = allDensity.sort(function(x, y){
           return d3.descending(x.median, y.median);
        });
      }
      return allDensity;
    }
    
    function update(_svg, allDensity){
      // Add areas
      var all_density_curves = _svg.select(".density")
        .selectAll("path")
        .data(allDensity, d=>d.key);
      
        all_density_curves.join("path")
          .attr("transform", function(d){return("translate(0," + (yName(d.key)-height) +")")})
          .attr("fill", d=>myColor(d.key))
          .datum(d=>d.density)
          .transition()
          .duration(500)
          .attr("opacity", 0.5)
          .attr("stroke", "#000")
          .attr("stroke-width", 0.1)
          .attr("d",  lineGenerator)
      
      _svg.select('.yAxis').call(yAxis);
    }
        
    var brewery_data = "https://raw.githubusercontent.com/kkcp-dsi/CraftBeerRatingsAnalysis/main/data/all_breweries.csv"
    var rowConverter = function (d) {
      return {
        state: d.state,
        average_rating: +d.average_rating,
        num_of_beers: +d.num_of_beers
        }
    };
    // set the dimensions and margins of the graph
    var margin = {top: 100, right: 40, bottom: 50, left:100},
        width = 600 - margin.left - margin.right,
        height = 500 - margin.top - margin.bottom;
    
     // X axis: scale and draw:
    var xScale = d3.scaleLinear()
      .domain([2.0, 5.0]) 
      .range([0, width]);

    var yScale = d3.scaleLinear()
      .domain([0.0, 10.0])
      .range([ height, 0]);
    
    var xAxis = d3.axisBottom()
      .scale(xScale);
      
    var yName = d3.scaleBand()
      .range([0, height])
      .paddingInner(1);

    var yAxis = d3.axisLeft()
      .scale(yName);
            
    var myColor =  d3.scaleOrdinal()
      .range(d3.schemeSet3);
    
    var lineGenerator = d3.line()
      .curve(d3.curveBasis)
      .x(d=>xScale(d[0]))
      .y(d=>yScale(d[1]));
    
    // append the svg object to the body of the page
    var svg = create_svg(d3.select("#state_hist"), height, width,  xAxis, yAxis, "Average rating");
    var svg_popular = create_svg(d3.select("#state_hist_popular"), height, width,  xAxis, yAxis, "Top 20 brewery average rating");
    
    d3.csv(brewery_data, rowConverter).then(function(data){
        //Process the data
        var state_average_beers = {};
        for (var i = 0; i < data.length; i++) {
          if (!(data[i].state in state_average_beers))
          {
            state_average_beers[data[i].state] = [];
          }
          state_average_beers[data[i].state].push(data[i].average_rating); 
        }
        
        var state_popular_average_beers = {};
        for (key in state_average_beers){
          ratings_by_state = state_average_beers[key];
          sorted_ratings_by_state = d3.sort(ratings_by_state, d3.descending);
          state_popular_average_beers[key] = sorted_ratings_by_state.slice(0, 20);
        }
        
        var allStates = Object.keys(state_average_beers);
        
        myColor.domain(allStates);
        
        var mySelect = $('#states');
        $.each(state_average_beers, function(key, val) {
            mySelect.append(
                $('<option></option>').val(key).html(key)
            );
        });

        $('#select_all_states').change(function() {
            if(this.checked) {
              $('#states').prop('disabled', true);
              var sortedDensity = compute_density(allStates, state_average_beers, xScale.ticks(20));
              yName.domain($.map(sortedDensity, d => d.key));
              update(svg, sortedDensity);
              
              sortedDensity = compute_density(allStates, state_popular_average_beers, xScale.ticks(20));
              yName.domain($.map(sortedDensity, d => d.key));
              update(svg_popular, sortedDensity);
            }else{
               $('#states').prop('disabled', false);
               $("#states").change();
            }
        });
        
        var stateSelect = $("#states").select2({multiple: true});
        stateSelect.on("change", function (e) {
          var selections = $(e.currentTarget).val();
          var sortedDensity = compute_density(selections, state_average_beers, xScale.ticks(20));
          yName.domain($.map(sortedDensity, d => d.key));
          update(svg, sortedDensity);
          
          sortedDensity = compute_density(selections, state_popular_average_beers, xScale.ticks(20));
          yName.domain($.map(sortedDensity, d => d.key));
          update(svg_popular, sortedDensity);
        });
        $("#states").change();
      });
    </script>
</html>
