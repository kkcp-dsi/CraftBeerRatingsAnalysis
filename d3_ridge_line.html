<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Vertical Bar Chart</title>
    <script src="https://d3js.org/d3.v7.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
  </head>
  
  <body>
    <div class="container-fluid">
      <div class="row">
        <div class="col-4">
          <select id="states" style="width:100%"></select>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" value="" id="select_all_states">
            <label class="form-check-label" for="flexCheckDefault">
              Select all states
            </label>
          </div>
        </div>
      </div>
      <div class="row">
        <div class="col-6">
          <div id="state_hist"></div>
        </div>
      </div>
    </div>
  </body>
  <script>
    // This is what I need to compute kernel density estimation
    function kde(kernel, thresholds, data) {
      return thresholds.map(t => [t, d3.mean(data, d => kernel(t - d))]);
    }
    
    function epanechnikov(bandwidth) {
      return x => Math.abs(x /= bandwidth) <= 1 ? 0.75 * (1 - x * x) / bandwidth : 0;
    }
    var brewery_data = "https://raw.githubusercontent.com/kkcp-dsi/CraftBeerRatingsAnalysis/main/data/all_breweries.csv"
    var rowConverter = function (d) {
      return {
        state: d.state,
        average_rating: +d.average_rating,
        num_of_beers: +d.num_of_beers
        }
    };
    // set the dimensions and margins of the graph
    var margin = {top: 100, right: 40, bottom: 50, left:50},
        width = 600 - margin.left - margin.right,
        height = 500 - margin.top - margin.bottom;
    
    // append the svg object to the body of the page
    var svg = d3.select("#state_hist")
      .append("svg")
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom)
      .append("g")
        .attr("transform", "translate(" + margin.left + "," + margin.top + ")");
    
       // X axis: scale and draw:
      var x = d3.scaleLinear()
        .domain([2.0, 5.0]) 
        .range([0, width]);
  
      var y = d3.scaleLinear()
        .domain([0.0, 10.0])
        .range([ height, 0]);
      
      var xAxis = d3.axisBottom()
        .scale(x);
        
      var yName = d3.scaleBand()
        .range([0, height])
        .paddingInner(1)

      var yAxis = d3.axisLeft()
        .scale(yName);
              
      var myColor =  d3.scaleOrdinal()
        .range(d3.schemeSet3);
      
      var lineGenerator = d3.line()
        .curve(d3.curveBasis)
        .x(d=>x(d[0]))
        .y(d=>y(d[1]));
      
      svg.append("g")
        .attr("class", "density")
      
      svg.append("g")
        .attr("class", "xAxis")
        .attr("transform", "translate(0," + height + ")")
        .call(xAxis);
                  
      svg.append("g")
        .attr("class", "yAxis")
        .call(yAxis);
        
      // Add X axis label:
      svg.append("text")
          .attr("text-anchor", "end")
          .attr("x", width / 2 + margin.right + 20)
          .attr("y", height + 40)
          .text("Average rating");
    
    d3.csv(brewery_data, rowConverter).then(function(data){
        //Process the data
        var state_average_beers = {};
        for (var i = 0; i < data.length; i++) {
          if (!(data[i].state in state_average_beers))
          {
            state_average_beers[data[i].state] = [];
          }
          state_average_beers[data[i].state].push(data[i].average_rating); 
        }
        
        var allStates = Object.keys(state_average_beers);
        
        myColor.domain(allStates);
        
        var mySelect = $('#states');
        $.each(state_average_beers, function(key, val) {
            mySelect.append(
                $('<option></option>').val(key).html(key)
            );
        });
            
        $('#select_all_states').change(function() {
            if(this.checked) {
               $('#states').prop('disabled', true);
                         var allDensity = [];
              for (i in allStates){
                var state = allStates[i]
                var density = kde(epanechnikov(0.3), x.ticks(20), state_average_beers[state])
                allDensity.push({
                  key: state,
                  density: density
                });
              }
              yName.domain(allStates);
              update(allDensity);
               
            }else{
               $('#states').prop('disabled', false);
               $("#states").change();
            }
        });
        
        var stateSelect = $("#states").select2({multiple: true});
        stateSelect.on("change", function (e) {
          
          var selections = $(e.currentTarget).val();
          
          var allDensity = [];
          for (i in selections){
            var state = selections[i]
            var density = kde(epanechnikov(0.3), x.ticks(20), state_average_beers[state])
            allDensity.push({
              key: state,
              density: density
            });
          }
          yName.domain(selections);
          update(allDensity);
        });
        $("#states").change();
      });
      
      function update(allDensity){
        // Add areas
        var all_density_curves = svg.select(".density")
          .selectAll("path")
          .data(allDensity, d=>d.key);
        
          all_density_curves.join("path")
            .attr("transform", function(d){return("translate(0," + (yName(d.key)-height) +")")})
            .attr("fill", d=>myColor(d.key))
            .datum(d=>d.density)
            .transition()
            .duration(500)
            .attr("opacity", 0.5)
            .attr("stroke", "#000")
            .attr("stroke-width", 0.1)
            .attr("d",  lineGenerator)
        
        svg.select('.yAxis').call(yAxis);
      }
    </script>
</html>
