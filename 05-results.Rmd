# Results

In the results section, we are going to start with exploring the brewery data. There are a few angles that we can go about this. Firstly, we will explore the distribution of the breweries across the US?; Secondly we will look at what styles of beer are most popular in different states because we think different states tend to brew or specialize in different styles. Last but not the least, we will investigate whether there is a difference in terms of the user rating behaviors across states because we suspect that people from different states might have different rating behaviors.

After exploring the brewery data, we will look at the beer data, and the specific traits of the beers we are going after include beer style, beer alcohol by volume (ABU), beer international bitterness units (IBU), and average user ratings, the big question is that why are certain beer styles getting attention and better ratings than others? We will aim to answer this question using a series of plots to understand different aspects of the beer data.

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, echo=FALSE, warning=FALSE, message=FALSE}
library(tidyverse)
library(maps)
library(mapdata)
library(choroplethr)
library(ggridges)
library(patchwork)
library(ggalluvial)
library(ggthemes)
library(RColorBrewer)
library(randomcoloR)
library(lubridate)

library(tmap)
library(tmaptools)
library(sf)
library(leaflet)
library(tigris)

source("utility/utility.R")
```

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='hide'}
us_geo <- states(class = "sf")
```

```{r, echo=FALSE, warning=FALSE, message=FALSE}
top_most_popular_beer_styles <- cleaned_all_beers %>%
  drop_na(beer_average_rating) %>%
  group_by(beer_style) %>%
  summarise(freq=n(), style_average_rating=mean(beer_average_rating)) %>%
  ungroup() %>%
  arrange(desc(freq)) %>%
  mutate(rn=row_number()) %>%
  filter(rn <= 20) %>%
  mutate(beer_style=fct_reorder(factor(beer_style), rn))
```

```{r, echo=FALSE, warning=FALSE, message=FALSE}
most_popular_beer_ratings <- top_most_popular_beer_styles %>% 
  inner_join(cleaned_all_beers, on = beer_style) %>%
  drop_na(beer_average_rating)
```

## Where are the breweries located?

Let's first take a look at a sample of the the brewery data below. The dataset contains the brewery name, description, address, geo coordinates, average user ratings of the brewery (calculated by the average rating of all beer ratings), the number of beers, the number of ratings given the brewery received in total, and etc.

```{r, echo=FALSE}
rmarkdown::paged_table(head(cleaned_all_breweries))
```

```{r, echo=FALSE, warning=FALSE, message=FALSE, fig.width=600}
state_avg_rating <- cleaned_all_breweries %>%
  group_by(state) %>%
  summarise(
    BreweryCount = n(),
    AverageRating = mean(average_rating),
    NumRatings = sum(as.numeric(num_of_ratings), na.rm = TRUE),
    NumOfBeers = sum(num_of_beers, na.rm = TRUE),
    NumOfCheckins = sum(as.numeric(total_check_ins), na.rm = TRUE),
    NumOfUniqueCheckins = sum(as.numeric(unique_user_check_ins), na.rm =
                                TRUE)
  ) %>%
  rename(NAME = state)

top_brewery_per_state <-
 cleaned_all_breweries %>% group_by(state) %>%
  mutate(brewery_rank = with_order(
order_by = average_rating,
    fun      = row_number,
    x        = desc(average_rating)
  )) %>%
  rename(NAME = state) %>%
  filter(brewery_rank == 1) %>%
  select(NAME, brewery, average_rating)

top_beer_per_state <-
 cleaned_all_beers %>% filter(beer_num_ratings > 2000) %>% group_by(state) %>%
  mutate(beer_rank = with_order(
order_by = beer_average_rating,
    fun      = row_number,
    x        = desc(beer_average_rating)
  )) %>%
  rename(NAME = state) %>%
  filter(beer_rank == 1) %>%
  select(NAME, beer_name, beer_average_rating)

top_beer_style_per_state <-
 cleaned_all_beers %>% group_by(state, beer_style) %>%
  summarise(AvgBeerStyleRating = mean(beer_average_rating, na.rm =
                                TRUE)) %>%
  mutate(beer_style_rank = with_order(
order_by = AvgBeerStyleRating,
    fun      = row_number,
    x        = desc(AvgBeerStyleRating)
  )) %>%
  rename(NAME = state) %>%
  filter(beer_style_rank == 1) %>%
  select(NAME, beer_style, AvgBeerStyleRating)


beer_style_beer <-
 inner_join(top_beer_per_state, top_beer_style_per_state)

beer_style_beer$NAME <- gsub('_', ' ', beer_style_beer$NAME)

beer_style_beer_brewery <-
 inner_join(top_brewery_per_state, beer_style_beer)

beer_style_beer_brewery$brewery = gsub('_', ' ', beer_style_beer_brewery$brewery)

state_beer_summary_info <- 
  inner_join(state_avg_rating, beer_style_beer_brewery)
```

We used [tigris](https://rdocumentation.org/packages/tigris/versions/1.5) for generating an interactive map to show the number of breweries across the US. When you click on each state, a popup window will appear to show the additional information such as the number of breweries, number of beers made, the average brewery rating for that state. Based on this map, it's clearly to see that most of the breweries are located in the northeast region, west coast, and Texas and Colorado. In particular, California has the most breweries (547 in total), which surpasses the runner-up Washington state (274 in total). If you want to have a full craft beer experience, I guess California would be the place to go!

```{r, echo=FALSE, warning=FALSE, message=FALSE}
mean_rating_map <- inner_join(us_geo, state_beer_summary_info) %>% select(
  NAME,
  AverageRating,
  BreweryCount,
  NumRatings,
  NumOfBeers,
  NumOfCheckins,
  NumOfUniqueCheckins,
  brewery,
  average_rating,
  beer_name,
  beer_average_rating,
  beer_style,
  AvgBeerStyleRating,
  geometry
)

mean_rating_map <-
  subset(mean_rating_map, !(NAME %in% c("Alaska", "Hawaii", "Puerto Rico")))

tmap_mode("view")

my_interactive_map <- tm_shape(mean_rating_map) +
  tm_polygons(
    "BreweryCount",
    popup.vars = c(
      "No.of Breweries: " = "BreweryCount",
      "Beers Produced: " = 'NumOfBeers',
      "Average Rating in State: " = "AverageRating",
      "Popular Brewery: " = "brewery",
      "Average Ratings for Popular Brewery :" = "average_rating",
      "Popular Beer Style :" = "beer_style",
      "Popular Beer :" = "beer_name"
    ),
    id = "NAME",
    border.col = "white",
    palette = "Greens"
  )

my_interactive_map <- tmap_leaflet(my_interactive_map)
my_interactive_map
```

## What kind of beer styles are most popular across the US?

Now that we know which states are making more beers than other, let's find out what beer styles are popular in each state. For this we will need to look at the beer dataset, so let's take a look at the sample of the data first. Although there are quite a few columns in the data, we will focus on ***state*** and ***beer style*** columns to answer this question. Due to a large number of beer styles in the dataset (1353 in total), we decided to only focus on the top 20 most popular beer styles across the country to avoid overplotting. Another reason is that a lot of values in the beer style columns are not actually beer styles, those values are either very specific type of a beer style such as Kali's Kolsch or a beer name that is misplaced in the beer style column such as Crimes of Calculations Fermented In Tempernillo Barrels.

```{r, echo=FALSE}
most_popular_beer_ratings %>%
  select(beer_style, state, beer_name, brewery, state, beer_desc) %>%
  sample_n(20) %>%
  rmarkdown::paged_table()
```

We decided not to compare the absolute frequencies across states due to the fact that states such as California and New York have way more breweries than states like Mississippi, the fills associated with those dominate states would overshadow the other states in a heatmap. To work around this issue, we calculated the relative frequency of the beer styles for each state and used it as the fill in the heatmap. And this is a reasonable decision because we just wanted to see what types of beer are more popular in different states.

```{r, echo=FALSE, fig.height=8, fig.width=10}
heatmap_input <- most_popular_beer_ratings %>%
  filter(rn <= 10) %>%
  mutate(state=gsub('[_]', ' ', state)) %>%
  group_by(state, beer_style) %>%
  summarise(freq=n(), rn=min(rn)) %>%
  mutate(scaled_freq=scale(freq))

ggplot(heatmap_input, aes(fct_reorder(beer_style, rn), fct_rev(fct_reorder(state, freq, max)), fill=scaled_freq)) +
  geom_tile(color="white") + 
  theme(
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.background = element_blank(),
    axis.line = element_line(colour = "black")
  ) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  ggtitle("Relative frequency of beer styles per state") +
  xlab("State") +
  ylab("Beer style") +
  scale_fill_gradient2(
    low = "#A1D3FA",
    mid = "#3670A0",
    high = "#142F47",
    breaks = c(-1, 0.8, 2.5),
    labels = c("low", "medium", "high"),
    guide = guide_colourbar(
      nbin = 100,
      draw.ulim = FALSE,
      draw.llim = FALSE,
      barheight = 5,
      title = "Relative frequency"
    )
  ) +
  scale_shape_manual(name = "Labels", values = levels(fct_reorder(
    factor(heatmap_input$beer_style), heatmap_input$rn
  )))
```

```{r}

```

The x-axis is ordered by the popularity of the beer style and y-axis is order by the number of breweries in the state. This heatmap clearly shows that IPAs are the most popular beers across the country with American IPA and New England IPA (NE IPA) and Double IPA (DIPA) leading on the popularity list. In particular, American IPA is the most dominant beer style in most of the states with a few exceptions. For example, breweries in Massachusetts and Connecticut tend to brew more New England IPAs, whereas Vermont and Rhode Island focus more on Double IPAs. In addition, it seems that states with more breweries tend to brew the popular kind of beers such as IPAs and the states with less breweries do not follow the trend and brew all kinds of styles. What stood out to us is that Fruited Sour is the most popular beer style in both North Dakota and South Dakota. What the heatmap has revealed actually corroborates with our experience, for instance, New England IPA first took off in the east coast such as in Massachusetts, in which the two of the best breweries [TreeHouse](https://treehousebrew.com/) and [Trillium](https://www.trilliumbrewing.com/) are located, it's not too surprising for us to see NE IPA as the most dominant beer style there.

## Do people rate beers/breweries differently across the US?

One of the questions we have long suspected is that people have different rating behaviors across regions, and this question was actually motivated by a conversation with our beer friends in the Netherlands, where our Dutch friends criticized that Americans always give high ratings to beers whereas Dutch people are more objective when it comes to beer rating, as a consequence, American beers tend to receive high ratings than the Dutch/European beers. It was quite an accusation and at the same time an interesting hypothesis, so this idea has been stuck with us for a long time, now it's time to put it to test! Unfortunately the data we've collected is only limited to the US, but the good news is that the same idea still applies to this data, therefore we decided to check whether people across different states have slightly different beer rating behaviors. So are people from certain states more generous or strict with ratings?

To answer this question, we will go back to our brewery data, where it contains the rating of every brewery (calculated as the average of all beer ratings) from every state, we could easily dump all of brewery ratings in ridgeline plot by state to look at rating behaviors across the country. To avoid overplotting, we will only show the top 20 states with the most breweries in this analysis.

```{r, echo=FALSE, fig.height=7}

top_20_states <- cleaned_all_breweries %>% 
  group_by(state) %>% 
  count() %>% 
  arrange(desc(n)) %>% 
  ungroup() %>%
  top_n(20)

cleaned_all_breweries %>%
  inner_join(top_20_states, on=state) %>%
  filter(average_rating > 3.0) %>%

ggplot(aes(average_rating, fct_reorder(state, average_rating))) + 
  geom_density_ridges(scale=4.0, alpha=0.5) + 
  ggtitle("Distribution of brewery ratings per state") + 
  xlab("Brewery rating") + 
  ylab("State")
```

Apparently most of the states follow a uni-modal distribution and their peaks are centered around the same rating, we don't observe any differences in terms of rating behaviors across the states. So this observation contrasts with our Dutch friend's hypothesis, perhaps he is wrong? After some serious pondering, we think our dear Dutch friend might be biased in their assessment, let's try to explain the rationale here. Our Dutch beer friend is a beer connoisseur and is on a mission to drink the best beers in the world, he has had more than 8000 unique beers at the time of writing based on his Untappd profile, our theory is that the American beers he finds at the local beer stores in the Netherlands or beer ordering websites only carry the best American beers, in addition, he is most likely only looking for American beers with high ratings and blatantly ignoring those with low-ratings, as a consequence, his sample of American beers might be biased towards the high rating ones. To test this theory, we are going to look at the same data again, however, this time we will simulate our friends' beer purchasing behavior where one would only order beers from the top 50 most highly rated breweries of each state.

```{r, echo=FALSE, fig.height=7}
cleaned_all_breweries %>%
  inner_join(top_20_states, on=state) %>%
  filter(average_rating > 3.0) %>%
  group_by(state) %>% 
  arrange(desc(average_rating)) %>% 
  mutate(rn=row_number()) %>%
  ungroup() %>%
  filter(rn <= 50) %>%

ggplot(aes(average_rating, fct_reorder(state, average_rating))) + 
  geom_density_ridges(scale=4.0, alpha=0.5) + 
  ggtitle("Distribution of top 50 breweries ratings per state") + 
  xlab("Brewery rating") + 
  ylab("State")
```

Now we can clearly see that there is a difference in terms of the distribution of the brewery ratings across the top 20 states. This confirmes our hypothesis about our friend's biased assessment towards the American beers, and we don't think there is a regional difference in terms of the beer rating behaviors.

## What are the popular beer styles?

Now let's take a look at the popular beer styles across the US. We define popularity as the number of beers associated with the corresponding beer styles. We do want to point out that a popular beer doesn't necessarily get a high rating and it only means this beer style is brewed/consumed more by people. The below Cleveland dot plot shows that American IPA is the most popular beer by far compared to other styles on the popularity list.

```{r, echo=FALSE}
top_most_popular_beer_styles <- cleaned_all_beers %>%
  drop_na(beer_average_rating) %>%
  group_by(beer_style) %>%
  summarise(freq=n(), style_average_rating=mean(beer_average_rating)) %>%
  ungroup() %>%
  arrange(desc(freq)) %>%
  mutate(rn=row_number()) %>%
  filter(rn <= 20) %>%
  mutate(beer_style=fct_reorder(factor(beer_style), rn))

ggplot(top_most_popular_beer_styles, aes(x=freq, y=fct_reorder(beer_style, freq))) +
  geom_point() + 
  ggtitle("Top 20 most popular beer styles") + 
  xlab("Num of beers") + 
  ylab("Beer style")
```

### What makes IPA so popular?

Naturally, the next question is that what makes IPA so popular? Why do people love it so much? To answer this question, we will compare its beer characteristics (IBU and ABV) with other beer styles. To avoid over plotting, we decide to group all IPAs together, all sour styles together and also lump all stouts and porters into a single category called Stout & Porter, we will leave out other beer styles in this analysis for now, when we get to the D3 interactive component, we could look at the same type of information much more clearly.

```{r, echo=FALSE}
create_beer_category <- function(beer_style) {
  if (grepl("IPA", beer_style)){
    return ("IPA")
  }else if(grepl("Sour", beer_style)){
    return ("Sour")
  }else if(grepl("Stout", beer_style)){
    return ("Stout")
  }else if(grepl("Porter", beer_style)){
    return ("Porter")
  }
  return (NA)
}
```

```{r, echo=FALSE}
beer_category_scatter_plot <- cleaned_all_beers %>%
  select(beer_style, state, beer_average_rating, beer_abv, beer_ibu) %>%
  drop_na() %>%
  mutate(beer_category= factor(sapply(beer_style, create_beer_category))) %>%
  drop_na() %>%
  filter (beer_abv < 20) %>%
  filter (beer_ibu < 200) %>%
  mutate(beer_abv_category = ifelse(beer_abv < 6, "low", ifelse(beer_abv < 8, "median", "high"))) %>%
  mutate(beer_ibu_category = ifelse(beer_ibu < 30, "low", ifelse(beer_ibu < 50, "median", "high"))) %>%
  mutate(beer_rating_category = ifelse(beer_average_rating < 3.6, "low", ifelse(beer_average_rating < 4.0, "median", "high"))) %>% 
  mutate(beer_abv_category = fct_rev(fct_reorder(beer_abv_category, beer_abv))) %>%
  mutate(beer_ibu_category = fct_rev(fct_reorder(beer_ibu_category, beer_ibu))) %>%
  mutate(beer_rating_category = fct_reorder(beer_rating_category, beer_average_rating))
```

```{r, echo=FALSE}
ggplot(beer_category_scatter_plot, aes(beer_abv, beer_ibu, color=beer_category)) + 
  geom_point(alpha=0.6, size=2, stroke=0) + 
  ggtitle("Beer IBU V.S. Beer ABV") + 
  xlab("Beer ABV") + 
  ylab("Beer IBU")
```

As we can see from this scatter plot, the IPAs are more bitter than other beer styles, in addition, their alcohol percentage is higher than Sour but lower than the Stout. It looks like people prefer beers that are bitter (hoppy) but not too strong in terms of the alcohol content. This makes sense because IPAs are famous for their hoppiness, despite the high bitterness level, IPAs are normally very fruity at the same time due to the use of special hops in IPAs. Overall, they are relatively easy to drink and most of people could accept it for the first time. On the other hand, sour beers, porters and stouts are considered as "advanced beers", which might take newcomers some time to develop the appreciation for. When we portray the craft beer landscape, it could be thought of as a pyramid, where lagers, and IPAs are on the bottom and everyone could have easy access to it. As you climb the pyramid, Stouts and Porters would be the next level challenge, eventually once you reach the top of the pyramid, you would finally appreciate sour beers.

### Does popularity change over time?

Now we've established that IPAs are the most popular beer style by far, has IPA always been that popular? Does the popularity change at all over time? Because based on our experience, we know new beer styles are coming out all the time, breweries are quickly adapting to brew those beers to capture the momentum of the new beer styles. So let's look at the popularity over time, again the definition of popularity remains the same, which is defined as the number of beers associated with that particular beer style.

```{r, echo=FALSE, fig.height=7}
facted_hist_input <- cleaned_all_beers %>% 
  inner_join(top_most_popular_beer_styles, on=beer_style) %>%
  drop_na(c(beer_average_rating, year)) %>%
  select(beer_style, beer_added, year, rn) %>%
  mutate(year=as.double(year)) %>%
  mutate(beer_style=factor(beer_style))

ggplot(facted_hist_input, aes(year, fct_rev(fct_infreq(beer_style)))) + 
  geom_density_ridges(scale=3.0, alpha=0.5) + 
  ggtitle("Popularity of beer styles over time") + 
  xlab("Year") + 
  ylab("Beer style")
```

Wow! Pretty interesting, apparently three beer styles including New England IPA, Double New England, and Sour - Fruited took off recently after 2016. We could see New England IPA surpassed American IPA at some point. Porter used to popular between 2012-2016 but its popularity started to come back down. Although this gives us a rough sense of beer popularity over time, it doesn't tell us the exact popularity rank of each beer style, and how the rank changes. To do that, we created an alluvium diagram below to show the popularity rank of the most popular beer styles by year. Again we only included top 10 beer styles in this analysis to avoid overplotting. In addition, it's important to mention that the top 10 most popular beer styles at all time may not be the most popular beers in a specific year, so it's perfectly normal to see more beer styles in this alluvium diagram than the previous popularity plots in the same section.

```{r, echo=FALSE}
beer_style_production_by_year <- cleaned_all_beers %>%
  group_by(year, beer_style) %>%
  summarise(num_of_beers = n()) %>%
  filter(!is.na(year)) %>%
  filter(num_of_beers >= 50)%>%
  mutate(production_rank = with_order(
    order_by = num_of_beers,
    fun      = row_number,
    x        = desc(num_of_beers)
  )) %>%
  filter(production_rank <= 10)
```

```{r, echo=FALSE, fig.width = 12, fig.height= 7}
beer_style_palette <- distinctColorPalette(25, runTsne = TRUE)
ggplot(
  beer_style_production_by_year,
  mapping = aes(
    alluvium = beer_style,
    x = year,
    stratum = factor(production_rank)
  )
) +
  geom_flow(aes(fill = beer_style), color = "black") +
  geom_stratum(aes(fill = beer_style)) +
  geom_text(stat = "alluvium",
            aes(
              label = paste(
                beer_style_production_by_year$production_rank,
                "-",
                abbreviate(beer_style_production_by_year$beer_style)
              )),
              size = 2
            ) +
  scale_fill_manual(values = beer_style_palette) +
  guides(y = "none", fill=guide_legend(ncol=4)) +
  theme_wsj(color="gray") +
  ggtitle("Beer styles Production Increases over years in America")
```

o VVla, this is cool! We could see the exact ranks of each beer style over time by year. Now we know New England IPA surpassed American IPA, and has been the most popular beer style in since 2019. Sour was only ranked at 9th in 2018 but moved up on the list to the rank 3rd in 2019. Farmhouse Ale enjoyed its popularity from 2012 through 2019, then fell out of the top 10 most popular beer style in the following year, but made it back to the list in 2021. Red American Amber also had a similar fate where it remained popular from 2010 till 2017, eventually fell out of favor in 2018. Imperial Stout is an interesting case where it was ranked at 9th in 2010, and disappeared in the subsequent years, it did make its comback in 2015 and ranked at 6th and remain on the popularity list. Milkshake IPA was a once super hyped beer style that made its short appearance on the list in 2019 and 2020. Surprisingly, American Lager took a spot in both 2020 and 2021 and ranked at 8t and 9t respectively, Lager (e.g. Budweiser) used to be considered "uncrafty" by the craft beer geeks, apparently brewers started making tweaks to the traditional recipes to make it more interesting.

## What are the highly rated beer styles?

So far we have looked at the popular beer styles, however, as stated previously a popular beer style doesn't always receive a high rating, it only suggests that people are drinking this style of beers a lot more than other styles. Okay now, let's find out what the most highly rated beer styles, we are going to show this using a boxplot. Again we will limit this analysis to the top 20 most popular beers.

```{r, echo=FALSE}
most_popular_beer_ratings <- top_most_popular_beer_styles %>% 
  inner_join(cleaned_all_beers, on = beer_style) %>%
  drop_na(beer_average_rating)
  
ggplot(most_popular_beer_ratings, aes(x=beer_average_rating, y= fct_reorder(beer_style, beer_average_rating))) +
  geom_boxplot() + 
  ggtitle("Boxplots of beer ratings for the top 20 most popular beer styles") + 
  xlab("Beer rating") + 
  ylab("Beer style")
```

This is interesting! The most deserved beer styles are New England IPA (including the Double version), Stout (including Imperial Stout and Milk Stout), Sour (Including Sour - Fruited and Sour - Other), and also Double IPA. The most popular beer style American IPA is not rated very favorably, on top of that, it has a lot outlines on the left, indicating there are a lot of badly rated American IPA beers. Although the median rating of the Farmhouse Ale is not very high, it seems to have a lot of outliers on the right side, suggesting there are lot of high rated Farmhouse Ales.

### What makes a beer more desirable?

We couldn't help but wonder why some beers are rated higher than others, perhaps the highly desired beers share the same characteristics? If so what are the those characteristics? We set out to answer this question by looking at beer IBU and beer ABV. Before we jump into the analysis, we want to clarify one thing, which is that different beer styles have fundamentally different characteristics, e.g. Imperial Stout is inherently more alcoholic and sweeter than American IPA, so it would inevitably introduce some noise if we treat all beer styles the same. As seasoned Untappd users ourselves, we would use different benchmarks when it comes to rating different beer styles. Due to this reason, we decided to focus on IPA styles only for answering this question (defined as the beer styles that contain the mention of IPA).

We used our beer experience to discretize beer IBU, beer ABU and beer rating using the following rules, and then create a mosaic plot.

-   If beer ABV value

    1.  \< 6% then low

    2.  \>= 6% and \< 8% then median

    3.  \>= 8% then high

-   If beer IBU value

    1.  \< 30 then low

    2.  \>= 30 and \< 50 then median

    3.  \>= 50 then high

-   If beer rating value

    1.  \< 3.6 then low

    2.  \>= 3.6 and \< 4 then median

    3.  \>= 4 then high

```{r, echo=FALSE}
beer_rating_mosaic <- cleaned_all_beers %>%
  select(beer_style, state, beer_average_rating, beer_abv, beer_ibu) %>%
  drop_na() %>%
  filter(grepl("IPA", beer_style)) %>%
  mutate(beer_abv_category = ifelse(beer_abv < 6, "low", ifelse(beer_abv < 8, "median", "high"))) %>%
  mutate(beer_ibu_category = ifelse(beer_ibu < 30, "low", ifelse(beer_ibu < 50, "median", "high"))) %>%
  mutate(beer_rating_category = ifelse(beer_average_rating < 3.6, "low", ifelse(beer_average_rating < 4.0, "median", "high"))) %>% 
  mutate(beer_abv_category = fct_rev(fct_reorder(beer_abv_category, beer_abv))) %>%
  mutate(beer_ibu_category = fct_rev(fct_reorder(beer_ibu_category, beer_ibu))) %>%
  mutate(beer_rating_category = fct_reorder(beer_rating_category, beer_average_rating)) %>%
  mutate(beer_abv = beer_abv_category, 
         beer_ibu = beer_ibu_category, 
         beer_rating=beer_rating_category)
```

```{r, echo=FALSE}
vcd::mosaic(beer_rating ~ beer_abv + beer_ibu, 
            direction=c("v", "v", "h"), 
            rot_labels = c(0, 90, 45, 90),
            set_var = c("a", "b", "c"),
            beer_rating_mosaic,
            highlighting_fill=brewer.pal(3, 'Reds'), 
            main="Beer rating V.S. beer abv and beer ibu for IPA styles")
```

The mosaic plot shows that IPAs with higher ABVs tend to receive a higher rating. In addition, the IPAs with low IBUs tend to get higher ratings as well. In other words, people tend to prefer a strong but not too hoppy IPA (hopefully very fruity), this actually makes sense to us because we all love to drink for both flavor and effect at the same time.

## What are the best breweries and what beers are they making?

We have looked the popular beer styles and their corresponding ratings. The next question is very relevant for us because we really want to know what the best breweries are and what they are making, this will facilitate us in our beer hunting adventure. However, there are so many breweries in the dataset, we will limit this analysis to the top 50 most highly rated breweries across the US.

```{r, echo=FALSE, fig.width=8, fig.height=7}
best_brewery_data <- cleaned_all_breweries %>% 
  select(brewery, average_rating) %>%
  arrange(desc(average_rating)) %>%
  top_n(62) %>%
  inner_join(most_popular_beer_ratings, by="brewery") %>%
  group_by(brewery, beer_style) %>%
  summarise(freq=n()) %>%
  group_by(brewery) %>%
  mutate(scaled_freq=scale(freq)) %>%
  ungroup() %>%
  drop_na() %>%
  mutate(across("brewery", str_replace_all, "_", " ")) %>%
  mutate(across("brewery", str_replace_all, "Brewing Company", "")) %>%
  mutate(across("brewery", str_replace_all, "Brewing", "")) %>%
  mutate(across("brewery", str_replace_all, "Co", "")) %>%
  mutate(across("brewery", str_replace_all, "Brewery", "")) %>%
  mutate(brewery = str_trim(brewery))

  
ggplot(best_brewery_data, aes(fct_infreq(beer_style), fct_infreq(brewery), fill=scaled_freq)) +
  geom_tile(color="white") + 
    theme(
    panel.grid.major = element_blank(), 
    panel.grid.minor = element_blank(),
    panel.background = element_blank(), 
    axis.line = element_line(colour = "black")
  ) + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) + 
  ggtitle("Relative frequency of beer styles per state") + 
  xlab("Brewery") + 
  ylab("Beer style") +
  scale_fill_gradient2(
    low = "#A1D3FA",
    mid = "#3670A0",
    high = "#142F47",
    breaks = c(-1, 0.8, 2.5),
    labels = c("low", "median", "high"),
    guide = guide_colourbar(nbin = 100, 
                            draw.ulim = FALSE, 
                            draw.llim = FALSE, 
                            barheight = 5,
                            title="Relative frequency")
   )
```

It looks like most of the top breweries are making a lot of IPAs at the first glance, this actually corroborates with what we've observed so far, which is that IPAs are the most popular beer styles and some of the IPA styles (New England or Double IPA) have the best ratings in the US. There are some all-around breweries such as Cypress Creek Southern Ales that brew all kinds of beer styles. On the other hand, more than half of the top breweries seem to specialize in certain beer styles, which is probably reason why they are so good at what they are doing. For example, Trilium, Treehouse and Other half only focus on IPAs, whereas breweries like Side Project, and Ladd & Lass brewing focus on the sour and farmhouse styles. We do want to emphasize the fact that we only scraped the top 24 beers for each brewery due to the limited information Untappd allows us to pull, however, we think 24 beers could be a good proxy for all beers of each brewery, because the beers from the same brewery do not deviate too much from what they've done in the past.
