# Results

In the results section, we are going to start with exploring the brewery data. There are a few angles that we can go about this. Firstly, we will explore the distribution of the breweries across the US?; Secondly we will look at what styles of beer are most popular in different states because we think different states tend to brew or specialize in different styles. Last but not the least, we will investigate whether there is a difference in terms of the user rating behaviors across states because we suspect that people from different states might have different rating behaviors.

After exploring the brewery data, we will look at the beer data, and the specific traits of the beers we are going after include beer style, beer alcohol by volume (ABU), beer international bitterness units (IBU), and average user ratings, the big question is that why are certain beer styles getting attention and better ratings than others? We will aim to answer this question using a series of plots to understand different aspects of the beer data.

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, echo=FALSE, warning=FALSE, message=FALSE}
library(tidyverse)
library(maps)
library(mapdata)
library(choroplethr)
library(ggridges)
library(patchwork)
library(ggalluvial)
library(ggthemes)
library(RColorBrewer)
library(randomcoloR)
library(lubridate)

library(tmap)
library(tmaptools)
library(sf)
library(leaflet)
library(tigris)

source("utility/utility.R")
```

```{r, echo=FALSE}
folder_path <- paste(getwd(), 'data', sep='/')
all_breweries <- read_csv(paste(folder_path, 'all_breweries.csv', sep='/'))
all_beers <- read_csv(paste(folder_path, 'all_beers.csv', sep='/'))
population <- read_csv(paste(folder_path, 'us_population_by_state_2020.csv', sep='/'))
```

```{r, echo=FALSE}
cleaned_all_breweries <- all_breweries %>%
  filter(num_of_beers >= 10) %>%
  filter(!brewery_type %in% c("proprietor", "bar", "nano", "closed"))
```

```{r, echo=FALSE, warning=FALSE, message=FALSE}
cleaned_all_beers <- all_beers %>% 
  mutate(beer_abv=as.double(str_trim(gsub("%\\s+ABV", "", beer_abv)))) %>%
  mutate(beer_ibu=as.double(str_trim(gsub("\\s+IBU", "", beer_ibu)))) %>%
  mutate(beer_added=as.Date(beer_added, format = "%m/%d/%y")) %>%
  mutate(year=format(beer_added, format="%Y")) %>%
  mutate(beer_style=sapply(beer_style, clean_up_beer_style))
```

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='hide'}
us_geo <- states(class = "sf")
```

```{r, echo=FALSE, warning=FALSE, message=FALSE}
top_most_popular_beer_styles <- cleaned_all_beers %>%
  drop_na(beer_average_rating) %>%
  group_by(beer_style) %>%
  summarise(freq=n(), style_average_rating=mean(beer_average_rating)) %>%
  ungroup() %>%
  arrange(desc(freq)) %>%
  mutate(rn=row_number()) %>%
  filter(rn <= 20) %>%
  mutate(beer_style=fct_reorder(factor(beer_style), rn))
```

```{r, echo=FALSE, warning=FALSE, message=FALSE}
most_popular_beer_ratings <- top_most_popular_beer_styles %>% 
  inner_join(cleaned_all_beers, on = beer_style) %>%
  drop_na(beer_average_rating)
```

## Where are the breweries located?

Let's first take a look at a sample of the the brewery data below. The dataset contains the brewery name, description, address, geo coordinates, average user ratings of the brewery (calculated by the average rating of all beer ratings), the number of beers, the number of ratings given the brewery received in total, and etc.

```{r, echo=FALSE}
rmarkdown::paged_table(head(cleaned_all_breweries))
```

```{r, echo=FALSE, warning=FALSE, message=FALSE, fig.width=600}
state_avg_rating <- cleaned_all_breweries %>%
  group_by(state) %>%
  summarise(
    BreweryCount = n(),
    AverageRating = mean(average_rating),
    NumRatings = sum(as.numeric(num_of_ratings), na.rm = TRUE),
    NumOfBeers = sum(num_of_beers, na.rm = TRUE),
    NumOfCheckins = sum(as.numeric(total_check_ins), na.rm = TRUE),
    NumOfUniqueCheckins = sum(as.numeric(unique_user_check_ins), na.rm =
                                TRUE)
  ) %>%
  rename(NAME = state)

top_brewery_per_state <-
 cleaned_all_breweries %>% group_by(state) %>%
  mutate(brewery_rank = with_order(
order_by = average_rating,
    fun      = row_number,
    x        = desc(average_rating)
  )) %>%
  rename(NAME = state) %>%
  filter(brewery_rank == 1) %>%
  select(NAME, brewery, average_rating)

top_beer_per_state <-
 cleaned_all_beers %>% filter(beer_num_ratings > 2000) %>% group_by(state) %>%
  mutate(beer_rank = with_order(
order_by = beer_average_rating,
    fun      = row_number,
    x        = desc(beer_average_rating)
  )) %>%
  rename(NAME = state) %>%
  filter(beer_rank == 1) %>%
  select(NAME, beer_name, beer_average_rating)

top_beer_style_per_state <-
 cleaned_all_beers %>% group_by(state, beer_style) %>%
  summarise(AvgBeerStyleRating = mean(beer_average_rating, na.rm =
                                TRUE)) %>%
  mutate(beer_style_rank = with_order(
order_by = AvgBeerStyleRating,
    fun      = row_number,
    x        = desc(AvgBeerStyleRating)
  )) %>%
  rename(NAME = state) %>%
  filter(beer_style_rank == 1) %>%
  select(NAME, beer_style, AvgBeerStyleRating)


beer_style_beer <-
 inner_join(top_beer_per_state, top_beer_style_per_state)

beer_style_beer$NAME <- gsub('_', ' ', beer_style_beer$NAME)

beer_style_beer_brewery <-
 inner_join(top_brewery_per_state, beer_style_beer)

beer_style_beer_brewery$brewery = gsub('_', ' ', beer_style_beer_brewery$brewery)

state_beer_summary_info <- 
  inner_join(state_avg_rating, beer_style_beer_brewery)
```

We used [tigris](https://rdocumentation.org/packages/tigris/versions/1.5) for generating an interactive map to show the number of breweries across the US. When you click on each state, a popup window will appear to show the additional information such as the number of breweries, number of beers made, the average brewery rating for that state. Based on this map, it's clearly to see that most of the breweries are located in the northeast region, west coast, and Texas and Colorado. In particular, California has the most breweries (547 in total), which surpasses the runner-up Washington state (274 in total). If you want to have a full craft beer experience, I guess California would be the place to go!

```{r, echo=FALSE, warning=FALSE, message=FALSE}
mean_rating_map <- inner_join(us_geo, state_beer_summary_info) %>% select(
  NAME,
  AverageRating,
  BreweryCount,
  NumRatings,
  NumOfBeers,
  NumOfCheckins,
  NumOfUniqueCheckins,
  brewery,
  average_rating,
  beer_name,
  beer_average_rating,
  beer_style,
  AvgBeerStyleRating,
  geometry
)

mean_rating_map <-
  subset(mean_rating_map, !(NAME %in% c("Alaska", "Hawaii", "Puerto Rico")))

tmap_mode("view")

my_interactive_map <- tm_shape(mean_rating_map) +
  tm_polygons(
    "BreweryCount",
    popup.vars = c(
      "No.of Breweries: " = "BreweryCount",
      "Beers Produced: " = 'NumOfBeers',
      "Average Rating in State: " = "AverageRating",
      "Popular Brewery: " = "brewery",
      "Average Ratings for Popular Brewery :" = "average_rating",
      "Popular Beer Style :" = "beer_style",
      "Popular Beer :" = "beer_name"
    ),
    id = "NAME",
    border.col = "white",
    palette = "Greens"
  )

my_interactive_map <- tmap_leaflet(my_interactive_map)
my_interactive_map
```

## What kind of beer styles are most popular across the US?

Now that we know which states are making more beers than other, let's find out what beer styles are popular in each state. For this we will need to look at the beer dataset, so let's take a look at the sample of the data first. Although there are quite a few columns in the data, we will focus on ***state*** and ***beer style*** columns to answer this question. Due to a large number of beer styles in the dataset (1353 in total), we decided to only focus on the top 20 most popular beer styles across the country to avoid overplotting. Another reason is that a lot of values in the beer style columns are not actually beer styles, those values are either very specific type of a beer style such as Kali's Kolsch or a beer name that is misplaced in the beer style column such as Crimes of Calculations Fermented In Tempernillo Barrels.

```{r, echo=FALSE}
most_popular_beer_ratings %>%
  select(beer_style, state, beer_name, brewery, state, beer_desc) %>%
  sample_n(20) %>%
  rmarkdown::paged_table()
```

We decided not to compare the absolute frequencies across states due to the fact that states such as California and New York have way more breweries than states like Mississippi, the fills associated with those dominate states would overshadow the other states in a heatmap. To work around this issue, we calculated the relative frequency of the beer styles for each state and used it as the fill in the heatmap. And this is a reasonable decision because we just wanted to see what types of beer are more popular in different states.

```{r, echo=FALSE, fig.height=8, fig.width=10}
heatmap_input <- most_popular_beer_ratings %>%
  filter(rn <= 10) %>%
  mutate(state=gsub('[_]', ' ', state)) %>%
  group_by(state, beer_style) %>%
  summarise(freq=n(), rn=min(rn)) %>%
  mutate(scaled_freq=scale(freq))

ggplot(heatmap_input, aes(fct_reorder(beer_style, rn), fct_rev(fct_reorder(state, freq, max)), fill=scaled_freq)) +
  geom_tile(color="white") + 
  theme(
    panel.grid.major = element_blank(), 
    panel.grid.minor = element_blank(),
    panel.background = element_blank(), 
    axis.line = element_line(colour = "black")
  ) + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) + 
  ggtitle("Relative frequency of beer styles per state") + 
  xlab("State") + 
  ylab("Beer style") +
  scale_fill_gradient2(
    low = "lightblue",
    mid = "blue",
    high = "darkblue",
    breaks = c(-1, 0.8, 2.5),
    labels = c("low", "medium", "high"),
    guide = guide_colourbar(nbin = 100, 
                            draw.ulim = FALSE, 
                            draw.llim = FALSE, 
                            barheight = 5,
                            title="Relative frequency")
   ) + 
  scale_shape_manual(name = "Labels", values = levels(fct_reorder(factor(heatmap_input$beer_style), heatmap_input$rn)))
```

The x-axis is ordered by the popularity of the beer style and y-axis is order by the number of breweries in the state. This heatmap clearly shows that IPAs are the most popular beers across the country with American IPA and New England IPA (NE IPA) and Double IPA (DIPA) leading on the popularity list. In particular, American IPA is the most dominant beer style in most of the states with a few exceptions. For example, breweries in Massachusetts and Connecticut tend to brew more New England IPAs, whereas Vermont and Rhode Island focus more on Double IPAs. In addition, it seems that states with more breweries tend to brew the popular kind of beers such as IPAs and the states with less breweries do not follow the trend and brew all kinds of styles. What stood out to us is that Fruited Sour is the most popular beer style in both North Dakota and South Dakota. What the heatmap has revealed actually corroborates with our experience, for instance, New England IPA first took off in the east coast such as in Massachusetts, in which the two of the best breweries [TreeHouse](https://treehousebrew.com/) and [Trillium](https://www.trilliumbrewing.com/) are located, it's not too surprising for us to see NE IPA as the most dominant beer style there.

## Do people rate beers/breweries differently across the US?

One of the questions we have long suspected is that people have different rating behaviors across regions, and this question was actually motivated by a conversation with our beer friends in the Netherlands, where our Dutch friends criticized that Americans always give high ratings to beers whereas Dutch people are more objective when it comes to beer rating, as a consequence, American beers tend to receive high ratings than the Dutch/European beers. It was quite an accusation and at the same time an interesting hypothesis, so this idea has been stuck with us for a long time, now it's time to put it to test! Unfortunately the data we've collected is only limited to the US, but the good news is that the same idea still applies to this data, therefore we decided to check whether people across different states have slightly different beer rating behaviors. So are people from certain states more generous or strict with ratings?

To answer this question, we will go back to our brewery data, where it contains the rating of every brewery (calculated as the average of all beer ratings) from every state, we could easily dump all of brewery ratings in ridgeline plot by state to look at rating behaviors across the country. To avoid overplotting, we will only show the top 20 states with the most breweries in this analysis.

```{r, echo=FALSE}

top_20_states <- cleaned_all_breweries %>% 
  group_by(state) %>% 
  count() %>% 
  arrange(desc(n)) %>% 
  ungroup() %>%
  top_n(20)

cleaned_all_breweries %>%
  inner_join(top_20_states, on=state) %>%
  filter(average_rating > 3.0) %>%

ggplot(aes(average_rating, fct_reorder(state, average_rating))) + 
  geom_density_ridges(scale=4.0, alpha=0.5) + 
  ggtitle("Distribution of brewery ratings per state") + 
  xlab("Brewery rating") + 
  ylab("State")
```

Apparently most of the states follow a uni-modal distribution and their peaks are centered around the same rating, we don't observe any differences in terms of rating behaviors across the states. So this observation contrasts with our Dutch friend's hypothesis, perhaps he is wrong? After some serious pondering, we think our dear Dutch friend might be biased in their assessment, let's try to explain the rationale here. Our Dutch beer friend is a beer connoisseur and is on a mission to drink the best beers in the world, he has had more than 8000 unique beers at the time of writing based on his Untappd profile, our theory is that the American beers he finds at the local beer stores in the Netherlands or beer ordering websites only carry the best American beers, in addition, he is most likely only looking for American beers with high ratings and blatantly ignoring those with low-ratings, as a consequence, his sample of American beers might be biased towards the high rating ones. To test this theory, we are going to look at the same data again, however, this time we will simulate our friends' beer purchasing behavior where one would only order beers from the top 50 most highly rated breweries of each state.

```{r, echo=FALSE, fig.height=7}
cleaned_all_breweries %>%
  inner_join(top_20_states, on=state) %>%
  filter(average_rating > 3.0) %>%
  group_by(state) %>% 
  arrange(desc(average_rating)) %>% 
  mutate(rn=row_number()) %>%
  ungroup() %>%
  filter(rn <= 50) %>%

ggplot(aes(average_rating, fct_reorder(state, average_rating))) + 
  geom_density_ridges(scale=4.0, alpha=0.5) + 
  ggtitle("Distribution of top 50 breweries ratings per state") + 
  xlab("Brewery rating") + 
  ylab("State")
```

Now we can clearly see that there is a difference in terms of the distribution of the brewery ratings across the top 20 states. This confirmes our hypothesis about our friend's biased assessment towards the American beers, and we don't think there is a regional difference in terms of the beer rating behaviors.

## What are the popular beer styles?

Now let's take a look at the popular beer styles across the US. We define popularity as the number of beers associated with the corresponding beer styles. We do want to point out that a popular beer doesn't necessarily get a high rating and it only means this beer style is brewed/consumed more by people. The below Cleveland dot plot shows that American IPA is the most popular beer by far compared to other styles on the popularity list.

```{r, echo=FALSE}
top_most_popular_beer_styles <- cleaned_all_beers %>%
  drop_na(beer_average_rating) %>%
  group_by(beer_style) %>%
  summarise(freq=n(), style_average_rating=mean(beer_average_rating)) %>%
  ungroup() %>%
  arrange(desc(freq)) %>%
  mutate(rn=row_number()) %>%
  filter(rn <= 20) %>%
  mutate(beer_style=fct_reorder(factor(beer_style), rn))

ggplot(top_most_popular_beer_styles, aes(x=freq, y=fct_reorder(beer_style, freq))) +
  geom_point() + 
  ggtitle("Top 20 most popular beer styles") + 
  xlab("Num of beers") + 
  ylab("Beer style")
```

Naturally, the next question is that what makes IPA so popular? Why do people love it so much? To answer this question, we will compare its beer characteristics (IBU and ABV) with other beer styles. To avoid over plotting, we decide to group all IPAs together, all sour styles together and also lump all stouts and porters into a single category called Stout & Porter, we will leave out other beer styles in this analysis for now, when we get to the D3 interactive component, we could look at the same type of information much more clearly.

```{r, echo=FALSE}
create_beer_category <- function(beer_style) {
  if (grepl("IPA", beer_style)){
    return ("IPA")
  }else if(grepl("Sour", beer_style)){
    return ("Sour")
  }else if(grepl("Stout", beer_style)){
    return ("Stout")
  }else if(grepl("Porter", beer_style)){
    return ("Porter")
  }
  return (NA)
}
```

```{r, echo=FALSE}
beer_category_scatter_plot <- cleaned_all_beers %>%
  select(beer_style, state, beer_average_rating, beer_abv, beer_ibu) %>%
  drop_na() %>%
  mutate(beer_category= factor(sapply(beer_style, create_beer_category))) %>%
  drop_na() %>%
  filter (beer_abv < 20) %>%
  filter (beer_ibu < 200) %>%
  mutate(beer_abv_category = ifelse(beer_abv < 6, "low", ifelse(beer_abv < 8, "median", "high"))) %>%
  mutate(beer_ibu_category = ifelse(beer_ibu < 30, "low", ifelse(beer_ibu < 50, "median", "high"))) %>%
  mutate(beer_rating_category = ifelse(beer_average_rating < 3.6, "low", ifelse(beer_average_rating < 4.0, "median", "high"))) %>% 
  mutate(beer_abv_category = fct_rev(fct_reorder(beer_abv_category, beer_abv))) %>%
  mutate(beer_ibu_category = fct_rev(fct_reorder(beer_ibu_category, beer_ibu))) %>%
  mutate(beer_rating_category = fct_reorder(beer_rating_category, beer_average_rating))
```

```{r, echo=FALSE}
ggplot(beer_category_scatter_plot, aes(beer_abv, beer_ibu, color=beer_category)) + 
  geom_point(alpha=0.6, size=2, stroke=0) + 
  ggtitle("Beer IBU v.s. Beer ABV") + 
  xlab("Beer ABV") + 
  ylab("Beer IBU")
```

As we can see from this scatter plot, the IPAs are more bitter than other beer styles, in addition, their alcohol percentage is higher than Sour but lower than the Stout. It looks like people prefer beers that are bitter (hoppy) but not too strong in terms of the alcohol content. This makes sense because IPAs are famous for their hoppiness, despite the high bitterness level, IPAs are normally very fruity at the same time due to the use of special hops in IPAs. Overall, they are relatively easy to drink and most of people could accept it for the first time. On the other hand, sour beers, porters and stouts are considered as "advanced beers", which might take newcomers some time to develop the appreciation for. When we portray the craft beer landscape, it could be thought of as a pyramid, where lagers, and IPAs are on the bottom and everyone could have easy access to it. As you climb the pyramid, Stouts and Porters would be the next level challenge, eventually once you reach the top of the pyramid, you would finally appreciate sour beers.

```{r, echo=FALSE}
facted_hist_input <- cleaned_all_beers %>% 
  inner_join(top_most_popular_beer_styles, on=beer_style) %>%
  drop_na(c(beer_average_rating, year)) %>%
  select(beer_style, beer_added, year, rn) %>%
  mutate(year=as.double(year)) %>%
  mutate(beer_style=factor(beer_style))

ggplot(facted_hist_input, aes(year, fct_rev(fct_infreq(beer_style)))) + 
  geom_density_ridges(scale=3.0, alpha=0.5) + 
  ggtitle("Popularity of beer styles over time") + 
  xlab("Year") + 
  ylab("Beer style")
```

```{r, echo=FALSE}
beer_style_production_by_year <- cleaned_all_beers %>%
  group_by(year, beer_style) %>%
  summarise(num_of_beers = n()) %>%
  filter(!is.na(year)) %>%
  filter(num_of_beers >= 50)%>%
  mutate(production_rank = with_order(
    order_by = num_of_beers,
    fun      = row_number,
    x        = desc(num_of_beers)
  )) %>%
  filter(production_rank <= 10)
```

we can understand the popularity of each beer style by number of beers added in each beer style per year. So we ranked top 10 beer styles per year by number of beers added in each bear style. By looking at rank change over years we can look at how the popularity is changing over time.

```{r, echo=FALSE, fig.width = 14, fig.height= 9}
beer_style_palette <- distinctColorPalette(25, runTsne = TRUE)
ggplot(
  beer_style_production_by_year,
  mapping = aes(
    alluvium = beer_style,
    x = year,
    stratum = factor(production_rank)
  )
) +
  geom_flow(aes(fill = beer_style), color = "black") +
  geom_stratum(aes(fill = beer_style)) +
  geom_text(
    stat = "alluvium",
    aes(label = beer_style_production_by_year$production_rank),
    size = 4
  ) +
  scale_fill_manual(values = beer_style_palette) +
  guides(y = "none") +
  theme_wsj(color="gray") +
  ggtitle("Beer styles Production Increases over years in America")
```

## What are the highly rated beer styles and what makes a beer better rated?

```{r, echo=FALSE}
most_popular_beer_ratings <- top_most_popular_beer_styles %>% 
  inner_join(cleaned_all_beers, on = beer_style) %>%
  drop_na(beer_average_rating)
  
ggplot(most_popular_beer_ratings, aes(x=beer_average_rating, y= fct_reorder(beer_style, beer_average_rating))) +
  geom_boxplot() + 
  ggtitle("Boxplots of beer ratings for the top 20 most popular beer styles") + 
  xlab("Beer rating") + 
  ylab("Beer style")
```

```{r, echo=FALSE}
beer_rating_mosaic <- cleaned_all_beers %>%
  select(beer_style, state, beer_average_rating, beer_abv, beer_ibu) %>%
  drop_na() %>%
  filter(grepl("IPA", beer_style)) %>%
  mutate(beer_abv_category = ifelse(beer_abv < 6, "low", ifelse(beer_abv < 8, "median", "high"))) %>%
  mutate(beer_ibu_category = ifelse(beer_ibu < 30, "low", ifelse(beer_ibu < 50, "median", "high"))) %>%
  mutate(beer_rating_category = ifelse(beer_average_rating < 3.6, "low", ifelse(beer_average_rating < 4.0, "median", "high"))) %>% 
  mutate(beer_abv_category = fct_rev(fct_reorder(beer_abv_category, beer_abv))) %>%
  mutate(beer_ibu_category = fct_rev(fct_reorder(beer_ibu_category, beer_ibu))) %>%
  mutate(beer_rating_category = fct_reorder(beer_rating_category, beer_average_rating))
```

```{r, echo=FALSE}
vcd::mosaic(beer_rating_category ~ beer_abv_category + beer_ibu_category, 
            direction=c("v", "v", "h"), 
            beer_rating_mosaic,
            highlighting_fill=brewer.pal(3, 'Reds'))
```

## What are the best breweries and what beers are they making?

```{r, echo=FALSE, fig.width=8, fig.height=6}
best_brewery_data <- cleaned_all_breweries %>% 
  select(brewery, average_rating) %>%
  arrange(desc(average_rating)) %>%
  top_n(50) %>%
  inner_join(most_popular_beer_ratings, by="brewery") %>%
  group_by(brewery, beer_style) %>%
  summarise(freq=n()) %>%
  group_by(brewery) %>%
  mutate(scaled_freq=scale(freq)) %>%
  ungroup() %>%
  drop_na() %>%
  mutate(across("brewery", str_replace_all, "_", " ")) %>%
  mutate(across("brewery", str_replace_all, "Brewing Company", "")) %>%
  mutate(across("brewery", str_replace_all, "Brewing", "")) %>%
  mutate(across("brewery", str_replace_all, "Co", "")) %>%
  mutate(across("brewery", str_replace_all, "Brewery", ""))
  
ggplot(best_brewery_data, aes(fct_infreq(beer_style), fct_infreq(brewery), fill=scaled_freq)) +
  geom_tile(color="white") + 
    theme(
    panel.grid.major = element_blank(), 
    panel.grid.minor = element_blank(),
    panel.background = element_blank(), 
    axis.line = element_line(colour = "black")
  ) + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) + 
  ggtitle("Relative frequency of beer styles per state") + 
  xlab("Brewery") + 
  ylab("Beer style") +
  scale_fill_gradient(
    breaks = c(-1, 0.8, 2.5),
    labels = c("low", "median", "high"),
    guide = guide_colourbar(nbin = 100, 
                            draw.ulim = FALSE, 
                            draw.llim = FALSE, 
                            barheight = 5,
                            title="Relative frequency")
   )
```
