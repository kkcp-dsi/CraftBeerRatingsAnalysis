<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Beer Style</title>
    <script src="https://d3js.org/d3.v7.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
  </head>
  
  <body>
    <div class="container-fluid">
      <div class="row">
        <div class="col-4">
          <select id="states" style="width:100%"></select>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" value="" id="select_all_states">
            <label class="form-check-label" for="flexCheckDefault">
              Select all states
            </label>
          </div>
        </div>
      </div>
      <div class="row">
        <div class="col-6">
          <div id="state_hist"></div>
        </div>
        <div class="col-6">
          <div id="state_hist_popular"></div>
        </div>
      </div>
      <div class="row">
        <div class="col-6">
          <div id="beer_abv"></div>
        </div>
        <div class="col-6">
          <div id="beer_ibu"></div>
        </div>
      </div>
    </div>
  </body>
  <script>
    // This is what I need to compute kernel density estimation
    function kde(kernel, thresholds, data) {
      return thresholds.map(t => [t, d3.mean(data, d => kernel(t - d))]);
    }
    
    function epanechnikov(bandwidth) {
      return x => Math.abs(x /= bandwidth) <= 1 ? 0.75 * (1 - x * x) / bandwidth : 0;
    }
    
    function create_svg(d3_html_element, _margin, _height, _width, _xAxis, _yAxis, _xAxisName){
      // append the svg object to the body of the page
      var _svg = d3_html_element.append("svg")
        .attr("width", _width + _margin.left + _margin.right)
        .attr("height", _height + _margin.top + _margin.bottom)
      .append("g")
        .attr("transform", "translate(" + _margin.left + "," + _margin.top + ")");
        
      _svg.append("g")
      .attr("class", "density")
    
      _svg.append("g")
        .attr("class", "xAxis")
        .attr("transform", "translate(0," + _height + ")")
        .call(_xAxis);
                  
      _svg.append("g")
        .attr("class", "yAxis")
        .call(_yAxis);
        
      // Add X axis label:
      _svg.append("text")
          .attr("text-anchor", "end")
          .attr("x", _width)
          .attr("y", _height + 40)
          .text(_xAxisName);
      return _svg;
    }
    
    function compute_density(states, state_data, ticks)
    {
      var allDensity = [];
      for (i in states){
        var state = states[i]
        var density = kde(epanechnikov(0.3), ticks, state_data[state]);
        allDensity.push({
          key: state,
          median: d3.median(state_data[state]),
          density: density
        });
        
        allDensity = allDensity.sort(function(x, y){
           return d3.descending(x.median, y.median);
        });
      }
      return allDensity;
    }
    
    function update(_svg, allDensity, lineGenerator){
      // Add areas
      var all_density_curves = _svg.select(".density")
        .selectAll("path")
        .data(allDensity, d=>d.key);
      
      all_density_curves.join("path")
        .attr("transform", function(d){return("translate(0," + (yName(d.key) - height) +")")})
        .attr("fill", d=>myColor(d.key))
        .datum(d=>d.density)
        .transition()
        .duration(500)
        .attr("opacity", 0.5)
        .attr("stroke", "#000")
        .attr("stroke-width", 0.1)
        .attr("d", lineGenerator)
      
      _svg.select('.yAxis').call(yAxis);
    }
    
    function update_hist(_svg, _bins)
    {
      var all_recs = _svg.select(".density")
        .selectAll("rect")
        .data(_bins, d=>d.key);
      
      var yScaleYearDomainMax = yScaleYear.domain()[1];
      yScaleYear.domain([0, yScaleYearDomainMax + 150 * yName.domain().length]);
      
      all_recs.enter().append("rect")
        .attr("class", "bar")
        .merge(all_recs)
        .attr("transform", function(d){
          return("translate(" + xScaleYear(d.x0) + "," + (yName(d.color) + yScaleYear(d.length) - height) +")")
        })
        .transition()
        .duration(500)
        .ease(d3.easeLinear)
        .attr("fill", d=>myColor(d.color))
        .attr("width", d=>xScaleYear(d.x1) - xScaleYear(d.x0))
        .attr("height", d=>height - yScaleYear(d.length));
      
      all_recs
          .exit()
          .transition()
          .duration(500)
          .ease(d3.easeLinear)
          .attr("height", 0)
          .remove();
      
      _svg.select('.yAxis').call(yAxis);
      
      yScaleYear.domain([0, yScaleYearDomainMax]);
    }
    
    function compute_hist(states, state_data, histogram)
    {
      var allDensity = [];
      for (i in states){
        var state = states[i]
        var bins = histogram(state_data[state]);
        bins = d3.map(bins, function(d, j){
          d["key"] = state + j;
          d["color"] = state;
          return d;
        });
        allDensity.push({
          key: state,
          bins: bins
        });
      }
      return allDensity;
    }
        
    var beer_data_path = "https://raw.githubusercontent.com/kkcp-dsi/CraftBeerRatingsAnalysis/main/data/all_beers_d3.csv";
    var rowConverter = function (d) {
      return {
        state: d.state,
        beer_style: d.beer_style,
        beer_abv: +d.beer_abv,
        beer_ibu: +d.beer_ibu,
        beer_average_rating: +d.beer_average_rating,
        beer_num_ratings: +d.beer_num_ratings,
        beer_added: d.beer_added,
        year: +d.year
        }
    };
    // set the dimensions and margins of the graph
    var margin = {top: 100, right: 40, bottom: 50, left:120},
        width = 800 - margin.left - margin.right,
        height = 600 - margin.top - margin.bottom;
    
     // X axis: scale and draw:
    var xScale = d3.scaleLinear()
      .domain([2.0, 5.0]) 
      .range([0, width]);
    
    var xAxis = d3.axisBottom()
      .scale(xScale);
    
    var yName = d3.scaleBand()
      .range([0, height])
      .paddingInner(1);

    var yAxis = d3.axisLeft()
      .scale(yName);

    var yScale = d3.scaleLinear()
      .domain([0.0, 10.0])
      .range([ height, 0]);
    
    var yScaleYear = d3.scaleLinear()
      .domain([0, 1000])
      .range([height, 0]);

    var myColor =  d3.scaleOrdinal()
      .range(d3.schemeSet3);
    
    var lineGenerator = d3.line()
      .curve(d3.curveBasis)
      .x(d=>xScale(d[0]))
      .y(d=>yScale(d[1]));
    
    var xScaleYear = d3.scaleTime().domain(
      [new Date("2010-01-01"), new Date("2021-01-01")]).range([0, width]);
    
    var formatDate = d3.timeFormat("%d/%m/%y");
    var xAxisYear = d3.axisBottom()
      .scale(xScaleYear)
      .tickFormat(formatDate);
    
    var histogram = d3.histogram()
      .value(d=>d)   // I need to give the vector of value
      .domain(xScaleYear.domain())  // then the domain of the graphic
      .thresholds(xScaleYear.ticks(100)); // then the numbers of bins
    
    // X axis for ABV
    var xScaleABV = d3.scaleLinear()
      .domain([0.0, 20.0]) 
      .range([0, width]);
    
    var xAxisABV = d3.axisBottom()
      .scale(xScaleABV);
    
    var yScaleABV = d3.scaleLinear()
      .domain([0.0, 4.0])
      .range([ height, 0]);
    
    var abvLineGenerator = d3.line()
      .curve(d3.curveBasis)
      .x(d=>xScaleABV(d[0]))
      .y(d=>yScaleABV(d[1]));
    
    // X axis for ABV
    var xScaleIBU = d3.scaleLinear()
      .domain([0.0, 200]) 
      .range([0, width]);
    
    var xAxisIBU = d3.axisBottom()
      .scale(xScaleIBU);
    
    var yScaleIBU = d3.scaleLinear()
      .domain([0.0, 2.0])
      .range([ height, 0]);
    
    var ibuLineGenerator = d3.line()
      .curve(d3.curveBasis)
      .x(d=>xScaleIBU(d[0]))
      .y(d=>yScaleIBU(d[1]));
    // append the svg object to the body of the page
    var svg = create_svg(d3.select("#state_hist"), margin, height, width,  xAxis, yAxis, "Beer style average rating");
    
    // append the svg object to the body of the page
    var svg_popularity = create_svg(d3.select("#state_hist_popular"), margin, height, width,  xAxisYear, yAxis, "Beer style popularity");
    
    var svg_abv = create_svg(d3.select("#beer_abv"), margin, height, width,  xAxisABV, yAxis, "Beer style ABV");
    
    var svg_ibu = create_svg(d3.select("#beer_ibu"), margin, height, width,  xAxisIBU, yAxis, "Beer style IBU");
    
    d3.csv(beer_data_path, rowConverter).then(function(data){
      var beer_style_data = {}
      for (var i in data)
      {
        if (!(data[i].beer_style in beer_style_data))
        {
          var beer_characteristics = {
            'beer_abv': [],
            'beer_ibu': [],
            'beer_average_rating':[],
            'beer_num_ratings':[],
            'beer_added': [],
            'year': []      
          }
          beer_style_data[data[i].beer_style] = beer_characteristics
        }
         beer_style_data[data[i].beer_style]['beer_abv'].push(data[i].beer_abv);
         beer_style_data[data[i].beer_style]['beer_ibu'].push(data[i].beer_ibu);
         beer_style_data[data[i].beer_style]['beer_average_rating'].push(data[i].beer_average_rating);
         beer_style_data[data[i].beer_style]['beer_num_ratings'].push(data[i].beer_num_ratings);
         beer_style_data[data[i].beer_style]['beer_added'].push(new Date(data[i].beer_added));
         beer_style_data[data[i].beer_style]['year'].push(data[i].year);
      }
      
      var items = Object.keys(beer_style_data).map(function(key) {
        return [key, beer_style_data[key]];
      }).sort(
        function(x, y){
          return d3.descending(x[1].beer_average_rating.length, y[1].beer_average_rating.length)
        }
      );
      
      var topItems = items.slice(0, 20);
      myColor.domain(topItems);
      
      var mySelect = $('#states');
      $.each(topItems, function(key, val) {
          mySelect.append(
              $('<option></option>').val(val[0]).html(val[0])
          );
      });

      $('#select_all_states').change(function() {
          if(this.checked) {
            $('#states').prop('disabled', true);
            
            var topItemsRatingData = {};
            var topItemsYearDate = {};
            var topItemsBeerABV = {};
            var topItemsBeerIBU = {};
            topItems.map(d => topItemsRatingData[d[0]] = d[1].beer_average_rating);
            topItems.map(d => topItemsYearDate[d[0]] = d[1].beer_added);
            topItems.map(d => topItemsBeerABV[d[0]] = d[1].beer_abv.filter(d=>!isNaN(d)));
            topItems.map(d => topItemsBeerIBU[d[0]] = d[1].beer_ibu.filter(d=>!isNaN(d)));
            
            sortedDensity = compute_density(Object.keys(topItemsRatingData), topItemsRatingData, xScale.ticks(20));
            yName.domain($.map(sortedDensity, d => d.key));
            update(svg, sortedDensity, lineGenerator);
            
            bins = compute_hist(Object.keys(topItemsYearDate), topItemsYearDate, histogram)
              .map(d=>d.bins).flat();
            update_hist(svg_popularity, bins);
            
            sortedDensity = compute_density(Object.keys(topItemsBeerABV), topItemsBeerABV, xScaleABV.ticks(20));
            update(svg_abv, sortedDensity, abvLineGenerator);
            
            sortedDensity = compute_density(Object.keys(topItemsBeerIBU), topItemsBeerIBU, xScaleIBU.ticks(20));
            update(svg_ibu, sortedDensity, ibuLineGenerator);
            
          }else{
             $('#states').prop('disabled', false);
             $("#states").change();
          }
      });
      
      var stateSelect = $("#states").select2({multiple: true});
      stateSelect.on("change", function (e) {
        
        var selections = $(e.currentTarget).val();
        var topItemsRatingData = {};
        var topItemsYearDate = {};
        var topItemsBeerABV = {};
        var topItemsBeerIBU = {};
        for (i in selections){
          var style = selections[i];
          topItemsRatingData[style] = beer_style_data[style].beer_average_rating;
          topItemsYearDate[style] = beer_style_data[style].beer_added;
          topItemsBeerABV[style] = beer_style_data[style].beer_abv.filter(d=>!isNaN(d));
          topItemsBeerIBU[style] = beer_style_data[style].beer_ibu.filter(d=>!isNaN(d));
        }
        sortedDensity = compute_density(Object.keys(topItemsRatingData), topItemsRatingData, xScale.ticks(20));
        yName.domain($.map(sortedDensity, d => d.key));
        update(svg, sortedDensity, lineGenerator);
        
        bins = compute_hist(Object.keys(topItemsYearDate), topItemsYearDate, histogram)
          .map(d=>d.bins).flat();
        update_hist(svg_popularity, bins);
        
        sortedDensity = compute_density(Object.keys(topItemsBeerABV), topItemsBeerABV, xScaleABV.ticks(10));
        update(svg_abv, sortedDensity, abvLineGenerator);
        
        sortedDensity = compute_density(Object.keys(topItemsBeerIBU), topItemsBeerIBU, xScaleIBU.ticks(20));
        update(svg_ibu, sortedDensity, ibuLineGenerator);
      });
      $("#states").change();
    });
    </script>
</html>
